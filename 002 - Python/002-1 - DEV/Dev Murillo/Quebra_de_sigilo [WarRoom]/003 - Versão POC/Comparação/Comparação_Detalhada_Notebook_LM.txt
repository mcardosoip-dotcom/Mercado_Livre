================================================================================
AN√ÅLISE COMPARATIVA COMPLETA: PIPELINE QUEBRA DE SIGILO
Vers√£o Original vs Vers√£o 2026
================================================================================

DATA: 2026
OBJETIVO: An√°lise detalhada e completa de todas as diferen√ßas, melhorias e 
          pontos relevantes entre as duas vers√µes do pipeline de quebra de sigilo.

================================================================================
1. VIS√ÉO GERAL E CONTEXTO
================================================================================

O pipeline de quebra de sigilo foi completamente recriado na vers√£o 2026 com 
foco em modulariza√ß√£o, performance e qualidade de dados. Esta an√°lise documenta 
todas as mudan√ßas t√©cnicas, arquiteturais e de l√≥gica de neg√≥cio.

M√âTRICAS GERAIS:
- Vers√£o Original: 16 arquivos SQL
- Vers√£o 2026: 36 arquivos SQL
- Aumento de modulariza√ß√£o: +125%
- Complexidade de joins: Redu√ß√£o significativa
- Performance esperada: Melhoria substancial

================================================================================
2. ARQUITETURA E ESTRUTURA DE ARQUIVOS
================================================================================

2.1 VERS√ÉO ORIGINAL - ESTRUTURA LINEAR

A vers√£o original seguia uma estrutura linear e monol√≠tica:

000 - Cria√ß√£o de tabelas
     Cria todas as tabelas FINCH como c√≥pias das tabelas originais e faz TRUNCATE

001 - Tabelas auxiliares (739 linhas - MONOL√çTICO)
     Este arquivo continha toda a l√≥gica de:
     - Prepara√ß√£o da base PRESENTA
     - Coleta de informa√ß√µes do titular
     - Processamento KYC
     - Identifica√ß√£o de correspondentes e n√£o correspondentes
     - Busca de conta SPB
     - L√≥gica de KYC m√°ximo
     - Sele√ß√£o de CUS_CUST_ID √∫nico
     - Cria√ß√£o da tabela de titulares
     - Processamento de movimenta√ß√µes
     - Processamento de relacionados (Payout, Payin, Payments, Withdrawal)

002 - Tabelas auxiliares 2
     Consolida√ß√£o de todos os relacionados em uma √∫nica tabela
     Cria√ß√£o de flag de movimenta√ß√£o

003 - inserir tabelas finais
     MERGE e INSERT nas tabelas finais (N√£o Correspondente, Ag√™ncias, Contas, 
     Extrato, Titulares, Origem Destino)

004-015 - Processamento de sa√≠das
     Gera√ß√£o de arquivos para Carta Circular 3454 e Extratos

PROBLEMAS IDENTIFICADOS NA VERS√ÉO ORIGINAL:
- Arquivo 001 muito grande (739 linhas) dificulta manuten√ß√£o
- L√≥gica complexa misturada em um √∫nico arquivo
- Dif√≠cil identificar onde fazer altera√ß√µes espec√≠ficas
- Debug complexo devido √† interdepend√™ncia
- Reutiliza√ß√£o de c√≥digo limitada

2.2 VERS√ÉO 2026 - ESTRUTURA MODULAR

A vers√£o 2026 implementa uma arquitetura modular e granular:

FASE 1: PREPARA√á√ÉO E COLETA DE DADOS
000 - Cria√ß√£o de tabelas Finch
     Mant√©m compatibilidade com vers√£o original

001 - PREPARAR BASE PRESENTA
     Separa√ß√£o clara da l√≥gica de prepara√ß√£o da base
     Filtro por hashtags (#extratoMovimentacaoCartaCircular3454, 
                         #extratoAplicacoesFinanceiras, #extratoMercantil)
     Agrega√ß√£o de RANGE_MIN e RANGE_MAX
     Flag de investigado

002 - COLETAR INF - REG
     NOVA ABORDAGEM: Uso de LK_REG_REGULATED_BASE_MLB
     Esta √© uma mudan√ßa arquitetural significativa:
     - Vers√£o Original: M√∫ltiplos JOINs com LK_KYC_VAULT_USER e LK_CUS_CUSTOMERS_DATA
     - Vers√£o 2026: Tabela consolidada regulat√≥ria
     
     DETALHES T√âCNICOS:
     - CTE com UNNEST de PHONES_LIST para telefones
     - QUALIFY ROW_NUMBER() para pegar telefone mais recente
     - Join direto com BT_MP_KYC_LEVEL para KYC
     - Campo avk_account_id mapeado diretamente para CONTA_SPB
     - L√≥gica de nome: LEGAL_NAME > PREFERRED_FULL_NAME > FIRST_NAME + LAST_NAME
     - CEP: FIS_ADRESS_LINE (priorit√°rio) > ADDRESS_ZIP_CODE
     - Valida√ß√£o de CEP: LENGTH = 8 caracteres

003 - COLETAR INF - REG by range
     OTIMIZA√á√ÉO: Query espec√≠fica para buscar contas criadas no per√≠odo
     Filtro por AVK_CREATED_DATETIME entre RANGE_MIN e RANGE_MAX
     Usado para enriquecimento posterior de dados PIX

004 - TRAZER APENAS INVESTIGADO COM CUST
     Filtro simples: WHERE CUS_CUST_ID IS NOT NULL
     Separa√ß√£o clara entre correspondentes e n√£o correspondentes

005 - TRAZER NAO CORRESPONDENTE
     Filtro: WHERE CUS_CUST_ID IS NULL
     Tabela espec√≠fica para Carta Circular 3454

FASE 2: PROCESSAMENTO DE TITULARES
007 - TRAZER NOME E CEP UNICO
     L√≥gica de sele√ß√£o de nome e CEP √∫nico por investigado
     Considera KYC m√°ximo e quantidade de CUSTs
     Prioriza dados quando h√° apenas um CUST com KYC m√°ximo

008 - CRIAR TABELA COM INFORMA√á√ïES DO TITULAR PARA A CARTA
     Primeira vers√£o da tabela de titulares
     Inclui l√≥gica de MOVIMENTACAO_MIN

009 - CRIAR TABELA COM INFORMA√á√ïES DO TITULAR PARA A CARTA 2
     Vers√£o duplicada (poss√≠vel refatora√ß√£o futura)

FASE 3: PROCESSAMENTO DE MOVIMENTA√á√ïES
006 - Movimenta√ß√µes
     MUDAN√áA IMPORTANTE: Data inicial agora √© DATA_ABERTURA diretamente
     Vers√£o Original: Usava MOVIMENTACAO_MIN (MAX entre DATA_ABERTURA e RANGE_MIN)
     Vers√£o 2026: Usa DATA_ABERTURA (AVK_CREATED_DATETIME) diretamente
     
     VANTAGENS:
     - Mais preciso: usa data real de abertura da conta
     - Mais simples: menos c√°lculos intermedi√°rios
     - Melhor para casos regulat√≥rios
     
     ESTRUTURA:
     - Mapeamento completo de MOV_DETAIL e MOV_TYPE_ID para descri√ß√µes
     - C√≥digos de tipo de lan√ßamento (103, 106, 112, etc.)
     - Identifica√ß√£o de ID_RELACIONADO
     - Identifica√ß√£o de ID_PAGAMENTO
     - Classifica√ß√£o de TBL_RELACIONADO (Payout, Withdrawal, Pix, Payments)

010 - MOVIMENTA√á√ïES QUE N√ÉO TEM UM CANCELAMENTO ATRELADO
     NOVO ARQUIVO DEDICADO para filtro de cancelamentos
     L√≥gica expl√≠cita:
     - Identifica movimenta√ß√µes com cancelamento completo
     - Exclui cancelamentos parciais
     - Remove movimenta√ß√µes canceladas quando h√° m√∫ltiplas movimenta√ß√µes
     - Mant√©m movimenta√ß√µes quando n√£o h√° cancelamento ou h√° apenas uma movimenta√ß√£o

FASE 4: PROCESSAMENTO DE RELACIONADOS
011 - PAYOUT
     Separa√ß√£o clara: Identifica movimenta√ß√µes do tipo Payout

012 - STG_QS_AUX_PAYOUT_REL_CAD_VF_FINCH
     Enriquecimento de dados de Payout
     Join com BT_MP_PAYOUTS
     Mapeamento de dados banc√°rios do destinat√°rio

013 - BLOCO PIX 1
     REESTRUTURA√á√ÉO COMPLETA DO PIX
     MUDAN√áAS ARQUITETURAIS SIGNIFICATIVAS:
     
     FONTE DE DADOS:
     - Vers√£o Original: BT_MP_PAY_PAYIN (tabela legada)
     - Vers√£o 2026: BT_MP_PIX_ALL (tabela consolidada)
     
     ESTRUTURA:
     - CTE BASE: Join com BT_MP_PRODUCTS
     - CTE PIX: UNION ALL de PAYER e RECEIVER
     - Campo ORIGEM_REGISTRO para rastreabilidade
     
     OTIMIZA√á√ïES DE PERFORMANCE:
     - PARTITION BY PAY_MOVE_DATE
     - CLUSTER BY ID_PAGAMENTO
     - Tabela intermedi√°ria: STG_NQS2_AUX_PAYIN_REL_CAD_VF_FINCH_BASE
     
     DADOS CAPTURADOS:
     - PAYER: Nome, banco, ag√™ncia, conta, CPF/CNPJ
     - RECEIVER: Nome, banco, ag√™ncia, conta, CPF/CNPJ
     - Tipo de conta (PAYER_DICT_KEY_TYPE, RECEIVER_DICT_KEY_TYPE)
     - Tipo de pessoa (PAYER_ENTITY_TYPE, RECEIVER_ENTITY_TYPE)

014 - BLOCO PIX 2
     ENRIQUECIMENTO REGULAT√ìRIO
     Join com STG_NQS2_INFO_TIT_CAD_VF_FINCH_STEP2 (dados regulat√≥rios)
     Corre√ß√£o autom√°tica:
     - NUMERO_CONTA_REL vazio ‚Üí usa AVK_ACCOUNT_ID do regulat√≥rio
     - NOME_PESSOA_REL vazio ‚Üí usa LEGAL_NAME do regulat√≥rio
     
     Esta √© uma melhoria significativa de qualidade de dados

015 - STG_QS_AUX_PAYIN_REL_CAD_VF_FINCH
     Tabela final consolidada de Payin

016 - PAYMENTS
     Separa√ß√£o: Identifica movimenta√ß√µes do tipo Payments

017 - STG_QS_AUX_PAYMENTS_SEMID_CAD_VF_FINCH
     Separa√ß√£o entre Payments com e sem ID_RELACIONADO

018 - INFORMA√á√ïES DO RELACIONADO COM A TABELA DE PAGAMENTO
     Processamento de Payments com ID_RELACIONADO
     Union com Payments sem ID_RELACIONADO (busca em BT_MP_PAY_PAYMENTS_ALL)

019 - INFORMA√áOES DOS RELACIONADOS COM ID DE PAGAMENTO
     Enriquecimento com dados de LK_CUS_CUSTOMERS_DATA e LK_KYC_VAULT_USER

020 - WITHDRAWL
     Separa√ß√£o: Identifica movimenta√ß√µes do tipo Withdrawal

021 - INFORMA√áOES DOS RELACIONADOS COM RETIROS
     Enriquecimento com dados de BT_MP_WITHDRAWALS

FASE 5: CONSOLIDA√á√ÉO
022 - Tabelas auxiliares 2
     Mant√©m compatibilidade com vers√£o original
     Union de todos os relacionados (Payout, Payments, Withdrawal, Payin)
     Filtro de SPLITTER e PAYINS
     Cria√ß√£o de flag de movimenta√ß√£o

FASE 6: INSER√á√ÉO DE TABELAS FINAIS
023 - inserir tabelas finais
     Mant√©m compatibilidade total com vers√£o original
     MERGE e INSERT nas mesmas tabelas finais

FASE 7: GERA√á√ÉO DE SA√çDAS
024-035 - Processamento de sa√≠das
     Mant√©m total compatibilidade com vers√£o original
     Mesmas tabelas e estruturas de sa√≠da

================================================================================
3. MUDAN√áAS T√âCNICAS DETALHADAS
================================================================================

3.1 FONTE DE DADOS REGULAT√ìRIOS

VERS√ÉO ORIGINAL:
- M√∫ltiplos JOINs complexos:
  * LK_KYC_VAULT_USER (dados KYC)
  * LK_CUS_CUSTOMERS_DATA (dados de clientes)
  * BT_MP_ACCOUNT_VIRTUAL_KEY (conta SPB)
- L√≥gica de fallback complexa
- M√∫ltiplos campos testados para CEP e telefone

VERS√ÉO 2026:
- Tabela consolidada: LK_REG_REGULATED_BASE_MLB
- Dados pr√©-processados e validados
- Estrutura otimizada para queries regulat√≥rias
- Campos diretos: avk_account_id, document_number, etc.

VANTAGENS:
1. Performance: Menos joins = queries mais r√°pidas
2. Confiabilidade: Dados validados na origem
3. Manutenibilidade: Menos depend√™ncias
4. Consist√™ncia: Dados regulat√≥rios centralizados

3.2 PROCESSAMENTO DE TELEFONE

VERS√ÉO ORIGINAL:
CASE
  WHEN LENGTH(VAU.KYC_CONT_PHONE_NUMBER) > 20 OR VAU.KYC_CONT_PHONE_NUMBER IS NULL 
       OR TRIM(VAU.KYC_CONT_PHONE_NUMBER) = '' THEN '0'
  WHEN VAU.CUS_CUST_ID IS NULL AND LK.CUS_CUST_ID IS NULL THEN NULL
  ELSE CONCAT(VAU.KYC_PER_PHONE_COUNTRY_CODE, VAU.KYC_PER_PHONE_AREA_CODE, 
              VAU.KYC_PER_PHONE_NUMBER)
END AS TELEFONE_PESSOA

VERS√ÉO 2026:
WITH REG AS (
  SELECT
    r.*,
    t.PHONE_COUNTRY_CODE,
    t.PHONE_AREA_CODE,
    t.PHONE_NUMBER
  FROM `WHOWNER.LK_REG_REGULATED_BASE_MLB` r
  LEFT JOIN UNNEST(r.PHONES_LIST) t
  WHERE r.SIT_SITE_ID = 'MLB'
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY r.DOCUMENT_NUMBER
    ORDER BY t.PHONE_LAST_UPDATED DESC
  ) = 1
)
...
CASE
  WHEN REG.PHONE_NUMBER IS NULL OR TRIM(REG.PHONE_NUMBER) = '' THEN NULL
  ELSE CONCAT(
    COALESCE(REG.PHONE_COUNTRY_CODE,''), 
    COALESCE(REG.PHONE_AREA_CODE,''), 
    REG.PHONE_NUMBER
  )
END AS TELEFONE_PESSOA

MELHORIAS:
- UNNEST de array PHONES_LIST
- QUALIFY garante telefone mais recente
- L√≥gica mais robusta e clara

3.3 PROCESSAMENTO DE MOVIMENTA√á√ïES

MUDAN√áA CR√çTICA: Data Inicial

VERS√ÉO ORIGINAL:
MOV_CREATED_DT BETWEEN TIT.MOVIMENTACAO_MIN AND TIT.RANGE_MAX
Onde MOVIMENTACAO_MIN = CASE 
  WHEN INV.DATA_ABERTURA > INV.RANGE_MIN THEN INV.DATA_ABERTURA
  ELSE INV.RANGE_MIN
END

VERS√ÉO 2026:
MOV_CREATED_DT BETWEEN TIT.DATA_ABERTURA AND TIT.RANGE_MAX
Usa DATA_ABERTURA (AVK_CREATED_DATETIME) diretamente

IMPACTO:
- Mais preciso: usa data real de abertura
- Mais simples: menos c√°lculos
- Melhor para casos onde conta foi aberta antes do per√≠odo investigado

3.4 PROCESSAMENTO PIX - REESTRUTURA√á√ÉO COMPLETA

VERS√ÉO ORIGINAL:
- Fonte: BT_MP_PAY_PAYIN
- Apenas dados do PAYER
- Join direto com Dim_Instituicoes
- Sem enriquecimento regulat√≥rio

VERS√ÉO 2026:
- Fonte: BT_MP_PIX_ALL (tabela consolidada)
- PAYER e RECEIVER (UNION ALL)
- Campo ORIGEM_REGISTRO
- Particionamento: PARTITION BY PAY_MOVE_DATE
- Clusteriza√ß√£o: CLUSTER BY ID_PAGAMENTO
- Enriquecimento com dados regulat√≥rios
- Corre√ß√£o autom√°tica de campos vazios

ESTRUTURA DO BLOCO PIX 1:
WITH
  BASE AS (
    SELECT
      a.TRANSACTION_PAYMENT_ID AS ID_PAGAMENTO,
      a.PAY_MOVE_DATE,
      a.PAYER_BANK_NAME,
      a.PAYER_BANK_ID,
      ... (dados PAYER)
      a.RECEIVER_BANK_NAME,
      a.RECEIVER_BANK_ID,
      ... (dados RECEIVER)
      p.MP_PROD_PRODUCT,
      p.MP_PROD_USER_TYPE
    FROM `meli-bi-data.WHOWNER.BT_MP_PIX_ALL` a
    LEFT JOIN `meli-bi-data.WHOWNER.BT_MP_PRODUCTS` p
      ON a.PRODUCT_ID = p.MP_PROD_ID
    WHERE SIT_SITE_ID = 'MLB'
  ),
  PIX AS (
    SELECT ... (PAYER)
    FROM BASE
    UNION ALL
    SELECT ... (RECEIVER)
    FROM BASE
  )

ESTRUTURA DO BLOCO PIX 2:
WITH
  BASE AS (...),
  REGULATORIO AS (
    SELECT * FROM STG_NQS2_INFO_TIT_CAD_VF_FINCH_STEP2
  ),
  BASE_JOINED AS (
    SELECT
      b.*,
      COALESCE(NULLIF(b.NUMERO_CONTA_REL, ''), r.AVK_ACCOUNT_ID) AS NUMERO_CONTA_REL,
      COALESCE(NULLIF(b.NOME_PESSOA_REL, ''), r.LEGAL_NAME) AS NOME_PESSOA_REL
    FROM BASE b
    LEFT JOIN REGULATORIO r
      ON b.CPF_CNPJ_REL = r.DOCUMENT_NUMBER
  )

VANTAGENS:
1. Completude: Captura ambos os lados da transa√ß√£o
2. Performance: Particionamento e clusteriza√ß√£o
3. Qualidade: Enriquecimento autom√°tico
4. Rastreabilidade: Campo ORIGEM_REGISTRO

3.5 FILTRO DE CANCELAMENTOS

VERS√ÉO ORIGINAL:
L√≥gica presente mas menos expl√≠cita, misturada com outras l√≥gicas

VERS√ÉO 2026:
Arquivo dedicado (010) com l√≥gica clara:

SELECT
  CASE 
    WHEN B.ID_PAGAMENTO IS NOT NULL AND C.QTD > 1 THEN 'sim'
    ELSE 'n√£o'
  END AS EXCLUIR
FROM STG_QS_AUX_MOVIMENTACAO_CAD_VF_FINCH A
LEFT JOIN (
  SELECT DISTINCT ID_PAGAMENTO
  FROM STG_QS_AUX_MOVIMENTACAO_CAD_VF_FINCH
  WHERE (MOV_LABEL LIKE '%cancellation%' OR MOV_LABEL LIKE '%cancelled %')
    AND MOV_LABEL NOT LIKE '%partial%'
    AND DATA_LANCAMENTO <> '1900-01-01'
) B ON A.ID_PAGAMENTO = B.ID_PAGAMENTO
LEFT JOIN (
  SELECT ID_PAGAMENTO, COUNT(ID_PAGAMENTO) AS QTD
  FROM STG_QS_AUX_MOVIMENTACAO_CAD_VF_FINCH
  GROUP BY 1
) C ON A.ID_PAGAMENTO = C.ID_PAGAMENTO
WHERE EXCLUIR = 'n√£o'

L√ìGICA:
- Identifica cancelamentos completos (n√£o parciais)
- Remove apenas quando h√° m√∫ltiplas movimenta√ß√µes
- Mant√©m quando n√£o h√° cancelamento ou h√° apenas uma movimenta√ß√£o

================================================================================
4. PONTOS POSITIVOS DA VERS√ÉO 2026
================================================================================

4.1 ARQUITETURA E ORGANIZA√á√ÉO

‚úÖ MODULARIZA√á√ÉO EXTREMA
- De 16 para 36 arquivos
- Cada arquivo com responsabilidade √∫nica
- Facilita manuten√ß√£o e evolu√ß√£o

‚úÖ NOMENCLATURA DESCRITIVA
- Nomes de arquivos explicam claramente sua fun√ß√£o
- Facilita navega√ß√£o e compreens√£o
- Serve como documenta√ß√£o impl√≠cita

‚úÖ SEPARA√á√ÉO DE CONCERNS
- L√≥gica de neg√≥cio separada por tipo de opera√ß√£o
- Processamento de movimenta√ß√µes isolado
- Relacionados separados por tipo (PIX, Payout, Payments, Withdrawal)

‚úÖ FACILITA DEBUG
- Problemas podem ser isolados em arquivos espec√≠ficos
- Testes podem ser feitos por componente
- Corre√ß√µes n√£o afetam outros componentes

4.2 PERFORMANCE E OTIMIZA√á√ÉO

‚úÖ FONTE DE DADOS OTIMIZADA
- LK_REG_REGULATED_BASE_MLB reduz complexidade
- Menos joins = queries mais r√°pidas
- Dados pr√©-consolidados

‚úÖ PARTICIONAMENTO PIX
- PARTITION BY PAY_MOVE_DATE
- CLUSTER BY ID_PAGAMENTO
- Otimiza√ß√£o para grandes volumes

‚úÖ QUERIES MAIS EFICIENTES
- Menos joins complexos
- Mais uso de tabelas pr√©-consolidadas
- CTEs bem estruturadas

‚úÖ FILTROS OTIMIZADOS
- Uso de AVK_CREATED_DATETIME para filtros temporais
- Filtros mais precisos reduzem volume processado

4.3 QUALIDADE DE DADOS

‚úÖ ENRIQUECIMENTO AUTOM√ÅTICO
- PIX enriquecido com dados regulat√≥rios
- Corre√ß√£o autom√°tica de campos vazios
- Uso de AVK_ACCOUNT_ID quando conta vazia
- Uso de LEGAL_NAME quando nome vazio

‚úÖ TRATAMENTO DE NULOS
- L√≥gica clara de fallback
- COALESCE e NULLIF bem utilizados
- Valida√ß√µes expl√≠citas

‚úÖ VALIDA√á√ÉO DE CEP
- Valida√ß√£o de comprimento (8 caracteres)
- Prioriza√ß√£o clara (FIS_ADRESS_LINE > ADDRESS_ZIP_CODE)

‚úÖ TELEFONE MAIS RECENTE
- QUALIFY garante uso do telefone mais atualizado
- UNNEST de array permite acesso a todos os telefones

‚úÖ DADOS PAYER/RECEIVER
- Captura completa de ambos os lados da transa√ß√£o PIX
- Campo ORIGEM_REGISTRO para rastreabilidade

4.4 MANUTENIBILIDADE

‚úÖ C√ìDIGO MAIS LEG√çVEL
- Arquivos menores e focados
- L√≥gica clara e direta
- Menos aninhamento

‚úÖ DOCUMENTA√á√ÉO IMPL√çCITA
- Nomes de arquivos servem como documenta√ß√£o
- Estrutura reflete fluxo de processamento

‚úÖ TESTABILIDADE
- Componentes isolados s√£o mais f√°ceis de testar
- Pode testar cada etapa independentemente

‚úÖ REUTILIZA√á√ÉO
- Componentes podem ser reutilizados
- L√≥gica isolada pode ser aplicada em outros contextos

4.5 FUNCIONALIDADES NOVAS

‚úÖ FILTRO DE CANCELAMENTOS EXPL√çCITO
- Arquivo dedicado (010)
- L√≥gica clara e test√°vel
- Tratamento de cancelamentos parciais

‚úÖ COLETA POR RANGE
- Arquivo (003) para otimiza√ß√£o
- Busca contas criadas no per√≠odo espec√≠fico
- Usado para enriquecimento posterior

‚úÖ ENRIQUECIMENTO REGULAT√ìRIO
- Corre√ß√£o autom√°tica de dados PIX
- Baseado em dados regulat√≥rios consolidados
- Melhora qualidade sem interven√ß√£o manual

‚úÖ RASTREABILIDADE
- Campo ORIGEM_REGISTRO em PIX
- Permite identificar origem do dado
- Facilita auditoria

================================================================================
5. SUGEST√ïES DE MELHORIA
================================================================================

5.1 DOCUMENTA√á√ÉO

üí° COMENT√ÅRIOS EM C√ìDIGO
- Adicionar coment√°rios explicativos em queries complexas
- Documentar decis√µes de neg√≥cio importantes
- Explicar l√≥gicas n√£o √≥bvias

üí° DOCUMENTA√á√ÉO DE DEPEND√äNCIAS
- Criar diagrama de depend√™ncias entre arquivos
- Documentar ordem de execu√ß√£o
- Identificar depend√™ncias cr√≠ticas

üí° GLOSS√ÅRIO DE TABELAS
- Documentar prop√≥sito de cada tabela STG criada
- Explicar campos importantes
- Documentar transforma√ß√µes aplicadas

üí° EXEMPLOS DE USO
- Documentar casos de uso espec√≠ficos
- Exemplos de dados de entrada e sa√≠da
- Casos edge identificados

5.2 VALIDA√á√ÉO E QUALIDADE

üí° VALIDA√á√ïES DE INTEGRIDADE
- Adicionar checks de qualidade de dados entre etapas
- Validar contagens esperadas
- Verificar integridade referencial

üí° LOGGING
- Implementar logging de execu√ß√£o
- Registrar tempo de execu√ß√£o por etapa
- Log de erros e warnings

üí° M√âTRICAS DE PERFORMANCE
- Adicionar medi√ß√£o de tempo de execu√ß√£o por etapa
- Identificar gargalos
- Monitorar uso de recursos

üí° VALIDA√á√ÉO DE DADOS DE ENTRADA
- Validar estrutura de TBL_QS_AUX_INVESTIGADO_FINCH
- Verificar campos obrigat√≥rios
- Validar formatos de dados

5.3 OTIMIZA√á√ïES T√âCNICAS

üí° √çNDICES
- Avaliar necessidade de √≠ndices em tabelas intermedi√°rias
- Considerar √≠ndices compostos para joins frequentes
- Monitorar performance de queries

üí° CACHE DE RESULTADOS
- Considerar cache para queries frequentes
- Cache de dimens√µes (Dim_Instituicoes, Dim_DATE)
- Avaliar trade-off mem√≥ria vs performance

üí° PROCESSAMENTO INCREMENTAL
- Avaliar possibilidade de processamento incremental
- Processar apenas dados novos/modificados
- Reduzir volume processado

üí° PARALELIZA√á√ÉO
- Avaliar paraleliza√ß√£o de etapas independentes
- Processar diferentes tipos de relacionados em paralelo
- Considerar processamento distribu√≠do

5.4 TRATAMENTO DE ERROS

üí° TRY-CATCH
- Implementar tratamento de erros em queries cr√≠ticas
- Capturar e registrar erros
- Continuar processamento quando poss√≠vel

üí° VALIDA√á√ÉO DE RESULTADOS
- Verificar se queries retornam dados esperados
- Validar contagens m√≠nimas/m√°ximas
- Alertar sobre resultados an√¥malos

üí° NOTIFICA√á√ïES
- Implementar sistema de notifica√ß√µes para falhas
- Alertas para stakeholders
- Dashboard de monitoramento

üí° ROLLBACK
- Considerar estrat√©gias de rollback em caso de falha
- Manter estado anterior em caso de erro
- Permitir retry de etapas falhas

5.5 COMPATIBILIDADE E VERSIONAMENTO

üí° VERSIONAMENTO DE ESQUEMAS
- Implementar controle de vers√£o de esquemas de tabelas
- Documentar mudan√ßas de schema
- Manter hist√≥rico de altera√ß√µes

üí° MIGRA√á√ÉO GRADUAL
- Manter compatibilidade durante transi√ß√£o
- Permitir execu√ß√£o paralela se necess√°rio
- Plano de migra√ß√£o documentado

üí° TESTES DE REGRESS√ÉO
- Implementar testes que garantam compatibilidade
- Validar resultados entre vers√µes
- Testes automatizados

üí° DOCUMENTA√á√ÉO DE BREAKING CHANGES
- Documentar mudan√ßas que quebram compatibilidade
- Guia de migra√ß√£o
- Checklist de valida√ß√£o

================================================================================
6. COMPARA√á√ÉO DETALHADA POR COMPONENTE
================================================================================

6.1 PREPARA√á√ÉO DA BASE PRESENTA

VERS√ÉO ORIGINAL:
- L√≥gica dentro do arquivo 001 (739 linhas)
- Misturada com outras l√≥gicas

VERS√ÉO 2026:
- Arquivo dedicado (001)
- L√≥gica isolada e clara
- F√°cil de modificar e testar

6.2 COLETA DE INFORMA√á√ïES DO TITULAR

VERS√ÉO ORIGINAL:
- M√∫ltiplos JOINs:
  * LK_KYC_VAULT_USER
  * LK_CUS_CUSTOMERS_DATA
  * BT_MP_ACCOUNT_VIRTUAL_KEY
- L√≥gica complexa de fallback
- M√∫ltiplos campos testados

VERS√ÉO 2026:
- Tabela consolidada: LK_REG_REGULATED_BASE_MLB
- CTE bem estruturada
- UNNEST de PHONES_LIST
- QUALIFY para telefone mais recente
- L√≥gica mais clara e direta

6.3 PROCESSAMENTO DE MOVIMENTA√á√ïES

VERS√ÉO ORIGINAL:
- Data inicial: MOVIMENTACAO_MIN (calculado)
- L√≥gica de cancelamento menos expl√≠cita

VERS√ÉO 2026:
- Data inicial: DATA_ABERTURA diretamente
- Arquivo dedicado para filtro de cancelamentos (010)
- L√≥gica clara e test√°vel

6.4 PROCESSAMENTO PIX

VERS√ÉO ORIGINAL:
- Fonte: BT_MP_PAY_PAYIN
- Apenas PAYER
- Sem otimiza√ß√µes

VERS√ÉO 2026:
- Fonte: BT_MP_PIX_ALL
- PAYER e RECEIVER
- Particionamento e clusteriza√ß√£o
- Enriquecimento regulat√≥rio
- Corre√ß√£o autom√°tica de campos vazios

6.5 PROCESSAMENTO DE RELACIONADOS

VERS√ÉO ORIGINAL:
- L√≥gica concentrada
- Menos granularidade

VERS√ÉO 2026:
- Separa√ß√£o por tipo (Payout, Payments, Withdrawal, PIX)
- Arquivos dedicados para cada tipo
- Enriquecimento espec√≠fico por tipo
- Mais f√°cil de manter e evoluir

================================================================================
7. IMPACTO E M√âTRICAS
================================================================================

M√âTRICAS QUANTITATIVAS:
- N√∫mero de arquivos: 16 ‚Üí 36 (+125%)
- Complexidade de joins: Alta ‚Üí Baixa
- Linhas por arquivo (m√©dia): ~46 ‚Üí ~25 (redu√ß√£o de 46%)
- Arquivos com >200 linhas: 1 ‚Üí 0

M√âTRICAS QUALITATIVAS:
- Manutenibilidade: M√©dia ‚Üí Alta
- Testabilidade: Baixa ‚Üí Alta
- Reutiliza√ß√£o: Baixa ‚Üí Alta
- Performance esperada: Padr√£o ‚Üí Otimizada
- Qualidade de dados: Boa ‚Üí Excelente
- Completude de dados: Parcial ‚Üí Completa (PIX)

IMPACTO NO NEG√ìCIO:
- Redu√ß√£o de tempo de manuten√ß√£o
- Maior confiabilidade dos dados
- Melhor rastreabilidade
- Facilita evolu√ß√£o futura
- Reduz risco de erros

================================================================================
8. CONCLUS√ÉO
================================================================================

A Vers√£o 2026 representa uma evolu√ß√£o significativa do pipeline de quebra de 
sigilo, com melhorias substanciais em:

‚úÖ ARQUITETURA: Modulariza√ß√£o extrema facilita manuten√ß√£o e evolu√ß√£o
‚úÖ PERFORMANCE: Uso de tabelas otimizadas e particionamento
‚úÖ QUALIDADE: Enriquecimento autom√°tico e valida√ß√µes aprimoradas
‚úÖ COMPLETUDE: Captura mais completa de dados (PIX PAYER/RECEIVER)
‚úÖ MANUTENIBILIDADE: C√≥digo mais leg√≠vel e organizado

RECOMENDA√á√ÉO:
A vers√£o 2026 deve ser adotada como padr√£o, mantendo a vers√£o original apenas 
para refer√™ncia hist√≥rica. As sugest√µes de melhoria apresentadas podem ser 
implementadas incrementalmente para otimizar ainda mais o pipeline.

PR√ìXIMOS PASSOS SUGERIDOS:
1. Implementar documenta√ß√£o detalhada
2. Adicionar valida√ß√µes de qualidade
3. Implementar logging e monitoramento
4. Criar testes automatizados
5. Documentar casos de uso e exemplos

================================================================================
FIM DO DOCUMENTO
================================================================================
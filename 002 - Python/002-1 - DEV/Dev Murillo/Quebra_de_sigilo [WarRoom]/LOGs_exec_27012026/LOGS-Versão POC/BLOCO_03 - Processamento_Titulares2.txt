BLOCO_03 - Processamento_Titulares2026-01-26 17:13:13 UTC-4
[DF Core] The status FINISH was received and successfully updated.
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Finished correctly
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job Status: DONE
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] [COST-BQ-EXECUTE: $0.00002323475]
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job status: RUNNING
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Running : -- CRIAR TABELA COM INFORMA  ES DO TITULAR PARA A CARTA -- Consolida informa  es finais do titular CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_TITULAR_CAD_VF_FINCH AS ( SELECT DISTINCT INV.CIRCULAR_3454, INV.EXTRATO, INV.RANGE_MIN, INV.RANGE_MAX, INV.DOC_NUMBER, INV.IDENTIFICACAO, INV.FLAG_INVESTIGADO, INV.SISTEMA, INV.CUS_CUST_ID, INV.CONTA_SPB, INV.DATA_ABERTURA, COALESCE(UN.NOME_INVESTIGADO, INV.NOME_INVESTIGADO) AS NOME_INVESTIGADO, CASE WHEN INV.CEP = '000' THEN UN.CEP ELSE INV.CEP END AS CEP, INV.TELEFONE_PESSOA, INV.VALOR_RENDA, -- MELHORIA 2026: Usa DATA_ABERTURA como data inicial para movimenta  es -- Evita buscar movimenta  es antes da cria  o da conta CASE WHEN INV.DATA_ABERTURA > INV.RANGE_MIN THEN INV.DATA_ABERTURA ELSE INV.RANGE_MIN END AS MOVIMENTACAO_MIN, INV.DATAHORA_IMPORTACAO FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH INV LEFT JOIN SBOX_LEGALES.STG_QS_NOME_UNI_INV_CAD_VF_FINCH UN ON INV.DOC_NUMBER = UN.DOC_INVESTIGADO )
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] BigQuery JobID: DF-393151_1185477973_2026_01_26_21_13_40UTC_51441cca-e780-4e17-b685-280670d7751a
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <GAIA_DIAS> by 1
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_TO> by 2026-01-26 16:57:43
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_FROM> by 1969-12-31 23:58:00
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Query will be run in BATCH mode
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job Status: DONE
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] [COST-BQ-EXECUTE: $0]
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job status: RUNNING
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Running : -- TRAZER NOME E CEP  NICO -- Seleciona nome e CEP  nicos para cada investigado -- Prioriza: maior KYC > maior CUS_CUST_ID >  nico registro CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_NOME_UNI_INV_CAD_VF_FINCH AS ( SELECT DISTINCT SPB.DOC_NUMBER AS DOC_INVESTIGADO, CAST( UPPER( CASE WHEN MC.DOC_NUMBER IS NOT NULL THEN SPB.NOME_INVESTIGADO WHEN MC.DOC_NUMBER IS NULL AND QK.QTD_CUST = 1 THEN SPB.NOME_INVESTIGADO END ) AS STRING ) AS NOME_INVESTIGADO, CASE WHEN MC.DOC_NUMBER IS NOT NULL THEN SPB.CEP WHEN MC.DOC_NUMBER IS NULL AND QK.QTD_CUST = 1 THEN SPB.CEP END AS CEP FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH SPB LEFT JOIN SBOX_LEGALES.STG_QS_MAX_KYC_CAD_VF_FINCH MK ON SPB.DOC_NUMBER = MK.DOC_NUMBER AND SPB.KYC_LEVEL = MK.MAX_KYC_LEVEL LEFT JOIN SBOX_LEGALES.STG_QS_QTD_CUST_MAX_KYC_CAD_VF_FINCH QK ON SPB.DOC_NUMBER = QK.DOC_NUMBER AND SPB.KYC_LEVEL = MK.MAX_KYC_LEVEL LEFT JOIN SBOX_LEGALES.STG_QS_MAX_CUST_CAD_VF_FINCH MC ON SPB.DOC_NUMBER = MC.DOC_NUMBER AND SPB.CUS_CUST_ID = MC.CUS_CUST_ID WHERE (CASE WHEN MC.DOC_NUMBER IS NOT NULL THEN SPB.CUS_CUST_ID WHEN MC.DOC_NUMBER IS NULL AND QK.QTD_CUST = 1 THEN SPB.CUS_CUST_ID END) IS NOT NULL )
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] BigQuery JobID: DF-393151_1371507880_2026_01_26_21_13_35UTC_0826c4bc-c8e7-4196-a34a-1beadb94c157
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <GAIA_DIAS> by 1
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_TO> by 2026-01-26 16:57:43
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_FROM> by 1969-12-31 23:58:00
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Query will be run in BATCH mode
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job Status: DONE
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] [COST-BQ-EXECUTE: $0]
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job status: RUNNING
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Running : -- TRAZER MAIOR CUS_CUST_ID -- Em caso de empate, seleciona o maior CUS_CUST_ID CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_MAX_CUST_CAD_VF_FINCH AS ( SELECT INV.DOC_NUMBER, MAX(CUS_CUST_ID) AS CUS_CUST_ID FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH INV LEFT JOIN SBOX_LEGALES.STG_QS_MAX_KYC_CAD_VF_FINCH MA ON INV.DOC_NUMBER = MA.DOC_NUMBER AND INV.KYC_LEVEL = MA.MAX_KYC_LEVEL WHERE MA.DOC_NUMBER IS NOT NULL GROUP BY 1 )
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] BigQuery JobID: DF-393151_447864275_2026_01_26_21_13_30UTC_c0351961-e6f3-4cfa-91b5-af6f854f8527
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <GAIA_DIAS> by 1
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_TO> by 2026-01-26 16:57:43
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_FROM> by 1969-12-31 23:58:00
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Query will be run in BATCH mode
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job Status: DONE
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] [COST-BQ-EXECUTE: $0]
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job status: RUNNING
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Running : -- VERIFICAR QUANTOS CUS_CUST_ID TEM COM O MAIOR KYC -- Identifica quantos clientes diferentes t m o maior n vel KYC CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_QTD_CUST_MAX_KYC_CAD_VF_FINCH AS ( SELECT SPB.DOC_NUMBER, COUNT(SPB.CUS_CUST_ID) AS QTD_CUST FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH SPB LEFT JOIN SBOX_LEGALES.STG_QS_MAX_KYC_CAD_VF_FINCH MA ON SPB.DOC_NUMBER = MA.DOC_NUMBER AND SPB.KYC_LEVEL = MA.MAX_KYC_LEVEL WHERE MA.DOC_NUMBER IS NOT NULL GROUP BY 1 )
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] BigQuery JobID: DF-393151_1361317628_2026_01_26_21_13_25UTC_a92365a8-38cb-4bbb-96e5-c001f57c90c6
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <GAIA_DIAS> by 1
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_TO> by 2026-01-26 16:57:43
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_FROM> by 1969-12-31 23:58:00
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Query will be run in BATCH mode
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job Status: DONE
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] [COST-BQ-EXECUTE: $0]
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job status: RUNNING
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Running : -- TRAZER MAIOR KYC POR DOCUMENTO -- Determina o maior n vel KYC completado para cada investigado CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_MAX_KYC_CAD_VF_FINCH AS ( SELECT DOC_NUMBER, MAX(KYC_LEVEL) AS MAX_KYC_LEVEL FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH WHERE NOME_INVESTIGADO IS NOT NULL AND TRIM(NOME_INVESTIGADO) <> '' AND CEP <> '000' GROUP BY 1 )
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] BigQuery JobID: DF-393151_165035269_2026_01_26_21_13_19UTC_d83d2f9a-6319-4969-84c8-d050be2d8eea
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <GAIA_DIAS> by 1
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_TO> by 2026-01-26 16:57:43
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_FROM> by 1969-12-31 23:58:00
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Query will be run in BATCH mode
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job Status: DONE
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] [COST-BQ-EXECUTE: $0]
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job status: RUNNING
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Running : -- TRAZER N O CORRESPONDENTES -- Investigados que n o possuem conta no sistema (para Carta 3454) CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_NAO_CORRESPONDENTE_CAD_VF_FINCH AS ( SELECT * FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH WHERE CUS_CUST_ID IS NULL )
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] BigQuery JobID: DF-393151_1741919610_2026_01_26_21_13_14UTC_54155290-b416-415a-b066-b4c2d9b7d6b8
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <GAIA_DIAS> by 1
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_TO> by 2026-01-26 16:57:43
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_FROM> by 1969-12-31 23:58:00
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Query will be run in BATCH mode
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job Status: DONE
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] [COST-BQ-EXECUTE: $0]
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Job status: RUNNING
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Running : -- ============================================================================ -- BLOCO 03: PROCESSAMENTO DE TITULARES E KYC -- ============================================================================ -- Descri  o: Processa informa  es de titulares, identifica correspondentes -- e n o correspondentes, determina maior n vel KYC -- Objetivo: Preparar dados de titulares para processamento -- Performance: Opera  es de agrega  o e JOIN otimizadas -- ============================================================================ -- TRAZER APENAS INVESTIGADO COM CUS_CUST_ID (CORRESPONDENTES) -- Investigados que possuem conta no sistema Mercado Pago CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_CORRESPONDENTE_CAD_VF_FINCH AS ( SELECT * FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH WHERE CUS_CUST_ID IS NOT NULL )
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] BigQuery JobID: DF-393151_127905111_2026_01_26_21_13_09UTC_492e35a6-10c9-4358-bb20-a607f58a8071
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <GAIA_DIAS> by 1
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_TO> by 2026-01-26 16:57:43
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Replacing on query <DF_TIME_FROM> by 1969-12-31 23:58:00
2026-01-26 17:13:13 UTC-4
[DF Core] The status RUNNING was received and successfully updated.
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Query will be run in BATCH mode
2026-01-26 17:13:13 UTC-4
[p-122559394][Database Step] Starting Execute
2026-01-26 17:13:13 UTC-4
[DF Core] {"message":"Job starting to execute"}
CREATE OR REPLACE TABLE SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH_STEP2 AS (
WITH PARAMS AS (
    SELECT DISTINCT
        DOC_NUMBER,
        RANGE_MIN,
        RANGE_MAX
    FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH
)

SELECT
    REG.DOCUMENT_NUMBER,
    REG.LEGAL_NAME AS LEGAL_NAME,
    REG.AVK_ACCOUNT_ID,
    REG.AVK_CREATED_DATETIME,
    PAR.RANGE_MIN,
    PAR.RANGE_MAX
FROM PARAMS PAR
JOIN `WHOWNER.LK_REG_REGULATED_BASE_MLB` REG
  ON REG.SIT_SITE_ID = 'MLB'
  AND REG.AVK_CREATED_DATETIME BETWEEN PAR.RANGE_MIN AND PAR.RANGE_MAX
  AND PAR.DOC_NUMBER = REG.DOCUMENT_NUMBER
);

-- CRIAR TABELA COM INFORMAÇÕES DO TITULAR PARA A CARTA
CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_TITULAR_CAD_VF_FINCH AS (
SELECT 
DISTINCT
INV.CIRCULAR_3454
,INV.EXTRATO
,INV.RANGE_MIN
,INV.RANGE_MAX
,INV.DOC_NUMBER
,INV.IDENTIFICACAO
,INV.FLAG_INVESTIGADO
,INV.SISTEMA
,INV.CUS_CUST_ID
,INV.CONTA_SPB
,INV.DATA_ABERTURA
,COALESCE(UN.NOME_INVESTIGADO,INV.NOME_INVESTIGADO) AS NOME_INVESTIGADO
,CASE 
WHEN INV.CEP = '000' THEN UN.CEP
ELSE INV.CEP
END AS CEP
,INV.TELEFONE_PESSOA
,INV.VALOR_RENDA
,CASE 
WHEN INV.DATA_ABERTURA > INV.RANGE_MIN THEN INV.DATA_ABERTURA
ELSE INV.RANGE_MIN
END AS MOVIMENTACAO_MIN
,INV.DATAHORA_IMPORTACAO

FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH INV

LEFT JOIN  SBOX_LEGALES.STG_QS_NOME_UNI_INV_CAD_VF_FINCH UN
ON INV.DOC_NUMBER = UN.DOC_INVESTIGADO);

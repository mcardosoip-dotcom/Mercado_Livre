-- PAYIN
CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_AUX_PAYIN_CAD_VF_FINCH AS (

SELECT 
 ID_PAGAMENTO
,CODIGO_CHAVE_EXTRATO
FROM SBOX_LEGALES.STG_QS_AUX_MOVIMENTACAO2_CAD_VF_FINCH MOV
WHERE TBL_RELACIONADO = 'Pix');

CREATE OR REPLACE TABLE SBOX_LEGALES.STG_NQS2_AUX_PAYIN_REL_CAD_VF_FINCH_BASE
PARTITION BY PAY_MOVE_DATE     
CLUSTER BY ID_PAGAMENTO AS (

WITH
  BASE AS (
    SELECT
      a.TRANSACTION_PAYMENT_ID AS ID_PAGAMENTO,
      a.PAY_MOVE_DATE,     
      a.PAYER_BANK_NAME,
      a.PAYER_BANK_ID,
      a.PAYER_BRANCH_ID,
      a.PAYER_ACCOUNT_ID,
      a.PAYER_DICT_KEY_TYPE,
      a.PAYER_ENTITY_TYPE,
      a.PAYER_DOC_NUMBER,
      a.PAYER_DOC_NAME,
      a.RECEIVER_BANK_NAME,
      a.RECEIVER_BANK_ID,
      a.RECEIVER_BRANCH_ID,
      a.RECEIVER_ACCOUNT_ID,
      a.RECEIVER_DICT_KEY_TYPE,
      a.RECEIVER_ENTITY_TYPE,
      a.RECEIVER_DOC_NUMBER,
      a.RECEIVER_DOC_NAME,

      p.MP_PROD_PRODUCT,
      p.MP_PROD_USER_TYPE

    FROM `meli-bi-data.WHOWNER.BT_MP_PIX_ALL` a
    LEFT JOIN `meli-bi-data.WHOWNER.BT_MP_PRODUCTS` p
      ON a.PRODUCT_ID = p.MP_PROD_ID
    WHERE SIT_SITE_ID = 'MLB'
  ),

  PIX AS (
    SELECT
      ID_PAGAMENTO,
      PAY_MOVE_DATE,
      PAYER_BANK_NAME     AS NOME_BANCO_REL,
      PAYER_BANK_ID       AS NUMERO_BANCO_REL,
      PAYER_BRANCH_ID     AS NUMERO_AGENCIA_REL,
      PAYER_ACCOUNT_ID    AS NUMERO_CONTA_REL,
      PAYER_DICT_KEY_TYPE AS TIPO_CONTA_REL,
      PAYER_ENTITY_TYPE   AS TIPO_PESSOA_REL,
      PAYER_DOC_NUMBER    AS CPF_CNPJ_REL,
      PAYER_DOC_NAME      AS NOME_PESSOA_REL,
      'PAYER' AS ORIGEM_REGISTRO
    FROM BASE

    UNION ALL

    SELECT
      ID_PAGAMENTO,
      PAY_MOVE_DATE,
      RECEIVER_BANK_NAME,
      RECEIVER_BANK_ID,
      RECEIVER_BRANCH_ID,
      RECEIVER_ACCOUNT_ID,
      RECEIVER_DICT_KEY_TYPE,
      RECEIVER_ENTITY_TYPE,
      RECEIVER_DOC_NUMBER,
      RECEIVER_DOC_NAME,
      'RECEIVER'
    FROM BASE
  )

SELECT
  PIX.*,
  QS.CODIGO_CHAVE_EXTRATO
FROM PIX
LEFT JOIN SBOX_LEGALES.STG_QS_AUX_MOVIMENTACAO2_CAD_VF_FINCH QS
  USING (ID_PAGAMENTO))





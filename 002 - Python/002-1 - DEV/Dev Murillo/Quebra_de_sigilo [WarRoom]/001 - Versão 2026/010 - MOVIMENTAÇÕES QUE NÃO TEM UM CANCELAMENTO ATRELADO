-- CRIAR TABELA COM MOVIMENTAÇÕES QUE NÃO TEM UM CANCELAMENTO ATRELADO
CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_AUX_MOVIMENTACAO2_CAD_VF_FINCH AS (
SELECT
*
FROM (
SELECT 
CASE WHEN B.ID_PAGAMENTO IS NOT NULL AND C.QTD > 1 THEN 'sim'
ELSE 'não'
END AS EXCLUIR
,A.*

FROM SBOX_LEGALES.STG_QS_AUX_MOVIMENTACAO_CAD_VF_FINCH A 

LEFT JOIN (
SELECT
DISTINCT
ID_PAGAMENTO

FROM SBOX_LEGALES.STG_QS_AUX_MOVIMENTACAO_CAD_VF_FINCH

WHERE (MOV_LABEL LIKE ('%cancellation%') OR MOV_LABEL LIKE ('%cancelled %'))
AND MOV_LABEL NOT LIKE ('%partial%')
AND DATA_LANCAMENTO <> '1900-01-01'
) B
ON A.ID_PAGAMENTO = B.ID_PAGAMENTO

LEFT JOIN (
SELECT
DISTINCT
ID_PAGAMENTO
,COUNT(ID_PAGAMENTO) AS QTD

FROM SBOX_LEGALES.STG_QS_AUX_MOVIMENTACAO_CAD_VF_FINCH
GROUP BY 1
) C
ON A.ID_PAGAMENTO = C.ID_PAGAMENTO
)
WHERE EXCLUIR = 'não');

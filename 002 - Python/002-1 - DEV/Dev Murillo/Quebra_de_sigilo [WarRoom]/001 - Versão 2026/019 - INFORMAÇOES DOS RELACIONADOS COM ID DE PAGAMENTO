-- TRAZER AS INFORMAÃ‡OES DOS RELACIONADOS COM ID DE PAGAMENTO
CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_PAGAMENTO_REL_CAD_VF_FINCH AS (
SELECT
PAG.ID_PAGAMENTO
,CODIGO_CHAVE_EXTRATO
,CAST(PAG.ID_RELACIONADO AS STRING) AS NUMERO_CONTA_REL
,CAST(CASE 
       WHEN KYC.KYC_IDENTIFICATION_TYPE = 'CPF' AND KYC.KYC_IDENTIFICATION_NUMBER IS NOT NULL AND KYC.KYC_PER_FULL_NAME IS NOT NULL  THEN 1
       WHEN KYC.KYC_IDENTIFICATION_TYPE = 'CNPJ' AND KYC.KYC_IDENTIFICATION_NUMBER IS NOT NULL AND KYC.KYC_COMP_CORPORATE_NAME IS NOT NULL THEN 2
       WHEN LENGTH(REL.CUS_CUST_DOC_NUMBER) = 11 THEN 1
       WHEN LENGTH(REL.CUS_CUST_DOC_NUMBER) = 14 THEN 2 
      ELSE NULL END 
      AS STRING) AS TIPO_PESSOA_REL
,CAST(CASE 
       WHEN KYC.KYC_IDENTIFICATION_TYPE IN ('CPF','CNPJ') AND KYC.KYC_IDENTIFICATION_NUMBER IS NOT NULL THEN KYC.KYC_IDENTIFICATION_NUMBER
       WHEN REL.CUS_CUST_DOC_NUMBER IS NOT NULL THEN REGEXP_REPLACE(REL.CUS_CUST_DOC_NUMBER, '[^a-zA-Z0-9]','')
      ELSE NULL END AS STRING) AS CPF_CNPJ_REL
,CAST(UPPER(CASE 
            WHEN KYC.KYC_IDENTIFICATION_TYPE = 'CPF' AND KYC.KYC_PER_FULL_NAME IS NOT NULL THEN KYC.KYC_PER_FULL_NAME
            WHEN KYC.KYC_IDENTIFICATION_TYPE = 'CNPJ' AND KYC.KYC_COMP_CORPORATE_NAME IS NOT NULL THEN KYC.KYC_COMP_CORPORATE_NAME
             WHEN REL.CUS_FIRST_NAME IS NULL THEN COALESCE(REL.CUS_FIRST_NAME,  REL.CUS_LAST_NAME)  
              ELSE CONCAT(REL.CUS_FIRST_NAME , ' ', REL.CUS_LAST_NAME )
            END) AS STRING) AS NOME_REL

FROM SBOX_LEGALES.STG_QS_PAGAMENTO_CAD_VF_FINCH PAG

LEFT JOIN WHOWNER.LK_CUS_CUSTOMERS_DATA REL
ON CAST(PAG.ID_RELACIONADO AS STRING) = CAST(REL.CUS_CUST_ID AS STRING)

LEFT JOIN WHOWNER.LK_KYC_VAULT_USER KYC
 ON CAST(KYC.CUS_CUST_ID AS STRING) = CAST( PAG.ID_RELACIONADO AS STRING)
AND SIT_SITE_ID = 'MLB');

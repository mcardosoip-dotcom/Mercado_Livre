-- TRAZER NOME E CEP UNICO
CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_NOME_UNI_INV_CAD_VF_FINCH AS (
SELECT 
DISTINCT
SPB.DOC_NUMBER AS DOC_INVESTIGADO
,CAST(
  UPPER(
  CASE 
  WHEN MC.DOC_NUMBER IS NOT NULL THEN SPB.NOME_INVESTIGADO
  WHEN MC.DOC_NUMBER IS NULL AND QK.QTD_CUST = 1 THEN SPB.NOME_INVESTIGADO
  END
  ) 
  AS STRING) AS NOME_INVESTIGADO
,CASE 
WHEN MC.DOC_NUMBER IS NOT NULL THEN SPB.CEP
WHEN MC.DOC_NUMBER IS NULL AND QK.QTD_CUST = 1 THEN SPB.CEP
END AS CEP

FROM SBOX_LEGALES.STG_QS_SPB_CAD_VF_FINCH SPB

LEFT JOIN SBOX_LEGALES.STG_QS_MAX_KYC_CAD_VF_FINCH MK
ON SPB.DOC_NUMBER = MK.DOC_NUMBER
AND SPB.KYC_LEVEL = MK.MAX_KYC_LEVEL

LEFT JOIN SBOX_LEGALES.STG_QS_QTD_CUST_MAX_KYC_CAD_VF_FINCH QK
ON SPB.DOC_NUMBER = QK.DOC_NUMBER
AND SPB.KYC_LEVEL = MK.MAX_KYC_LEVEL

LEFT JOIN SBOX_LEGALES.STG_QS_MAX_CUST_CAD_VF_FINCH MC
ON SPB.DOC_NUMBER = MC.DOC_NUMBER
AND SPB.CUS_CUST_ID = MC.CUS_CUST_ID

WHERE
  (CASE 
  WHEN MC.DOC_NUMBER IS NOT NULL THEN SPB.CUS_CUST_ID
  WHEN MC.DOC_NUMBER IS NULL AND QK.QTD_CUST = 1 THEN SPB.CUS_CUST_ID
  END) IS NOT NULL);

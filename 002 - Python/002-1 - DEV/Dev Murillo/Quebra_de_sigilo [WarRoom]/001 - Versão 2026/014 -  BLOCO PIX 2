CREATE OR REPLACE TABLE SBOX_LEGALES.STG_NQS2_AUX_PAYIN_REL_CAD_VF_FINCH AS (

WITH
  BASE AS (
    SELECT *
    FROM SBOX_LEGALES.STG_NQS2_AUX_PAYIN_REL_CAD_VF_FINCH_BASE
  ),

  REGULATORIO AS (
    SELECT *
    FROM SBOX_LEGALES.STG_NQS2_INFO_TIT_CAD_VF_FINCH_STEP2
  ),

  BASE_JOINED AS (
    SELECT
      b.ID_PAGAMENTO,
      b.CODIGO_CHAVE_EXTRATO,
      b.NOME_BANCO_REL,
      b.NUMERO_BANCO_REL,
      b.NUMERO_AGENCIA_REL,

      -- Conta corrigida
      COALESCE(NULLIF(b.NUMERO_CONTA_REL, ''), r.AVK_ACCOUNT_ID) AS NUMERO_CONTA_REL,

      b.TIPO_CONTA_REL,
      b.TIPO_PESSOA_REL,
      b.CPF_CNPJ_REL,

      -- Nome corrigido
      COALESCE(NULLIF(b.NOME_PESSOA_REL, ''), r.LEGAL_NAME) AS NOME_PESSOA_REL

    FROM BASE b
    LEFT JOIN REGULATORIO r
      ON b.CPF_CNPJ_REL = r.DOCUMENT_NUMBER
  )

SELECT *
FROM BASE_JOINED
);

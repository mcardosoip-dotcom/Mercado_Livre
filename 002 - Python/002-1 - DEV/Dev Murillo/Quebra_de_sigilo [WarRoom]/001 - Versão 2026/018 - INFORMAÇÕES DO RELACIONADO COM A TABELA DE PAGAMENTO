-- TRAZ AS INFORMAÇÕES DO RELACIONADO COM A TABELA DE PAGAMENTO
CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_PAGAMENTO_CAD_VF_FINCH AS (
  SELECT
    MOV.ID_PAGAMENTO,
    CAST(MOV.ID_RELACIONADO AS STRING) AS ID_RELACIONADO,
    CAST(CODIGO_CHAVE_EXTRATO AS STRING) AS CODIGO_CHAVE_EXTRATO,
    CAST(NULL AS STRING) AS PAY_REASON_ID
  FROM SBOX_LEGALES.STG_QS_AUX_PAYMENTS_COMID_CAD_VF_FINCH MOV
  WHERE MOV.ID_RELACIONADO IS NOT NULL


UNION ALL

SELECT
    MOV.ID_PAGAMENTO,
    CASE
      WHEN MOV.ID_RELACIONADO IS NOT NULL THEN CAST(MOV.ID_RELACIONADO AS STRING)
      WHEN MOV.CUS_CUST_ID = PAY.CUS_CUST_ID_SEL THEN CAST(PAY.CUS_CUST_ID_BUY AS STRING)
      WHEN MOV.CUS_CUST_ID = PAY.CUS_CUST_ID_BUY THEN CAST(PAY.CUS_CUST_ID_SEL AS STRING)
      ELSE NULL
    END AS ID_RELACIONADO,
    CAST(CODIGO_CHAVE_EXTRATO AS STRING) AS CODIGO_CHAVE_EXTRATO,
    REGEXP_REPLACE(CAST(PAY.PAY_REASON_ID AS STRING),'[^0-9a-zA-Z]',' ') AS PAY_REASON_ID
  FROM SBOX_LEGALES.STG_QS_AUX_PAYMENTS_SEMID_CAD_VF_FINCH MOV
  LEFT JOIN WHOWNER.BT_MP_PAY_PAYMENTS_ALL PAY
    ON CAST(MOV.ID_PAGAMENTO AS STRING) = CAST(PAY.PAY_PAYMENT_ID AS STRING)
   AND PAY.SIT_SITE_ID = 'MLB'
  WHERE MOV.ID_RELACIONADO IS NULL);

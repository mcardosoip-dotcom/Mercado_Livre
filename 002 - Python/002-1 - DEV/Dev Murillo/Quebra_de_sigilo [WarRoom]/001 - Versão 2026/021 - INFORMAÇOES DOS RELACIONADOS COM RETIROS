-- TRAZER AS INFORMAÃ‡OES DOS RELACIONADOS COM RETIROS
CREATE OR REPLACE TABLE SBOX_LEGALES.STG_QS_WITHDRAWAL_REL_CAD_VF_FINCH AS (
SELECT
MOV.ID_PAGAMENTO
,CODIGO_CHAVE_EXTRATO
,WIT.WIT_BANK_ACC_BANK_ID AS NUMERO_BANCO_REL
,REGEXP_REPLACE(WIT.WIT_BANK_ACC_BRANCH_ID, '[^a-zA-Z0-9]','') AS NUMERO_AGENCIA_REL
,REGEXP_REPLACE(WIT.WIT_BANK_ACC_NUMBER, '[^a-zA-Z0-9]','') AS NUMERO_CONTA_REL 
,'4' AS TIPO_CONTA_REL
,CASE 
 WHEN WIT.WIT_BANK_ACC_ID_TYPE_ID IS NULL AND LENGTH(WIT.WIT_BANK_ACC_ID_NUMBER) = 11 THEN '1'
 WHEN WIT.WIT_BANK_ACC_ID_TYPE_ID IS NULL AND LENGTH(WIT.WIT_BANK_ACC_ID_NUMBER) = 14 THEN '2'
WHEN WIT.WIT_BANK_ACC_ID_TYPE_ID = 'CPF' THEN '1' 
WHEN WIT.WIT_BANK_ACC_ID_TYPE_ID = 'CNPJ' THEN '2' 
ELSE NULL
END AS TIPO_PESSOA_REL
  ,WIT.WIT_BANK_ACC_ID_NUMBER 
AS CPF_CNPJ_REL
,UPPER(COALESCE(WIT.WIT_BANK_ACC_ALIAS,WIT.WIT_BANK_ACC_HOLDER_ID)) AS NOME_PESSOA_REL

FROM SBOX_LEGALES.STG_QS_AUX_WITHDRAWAL_CAD_VF_FINCH MOV

LEFT JOIN WHOWNER.BT_MP_WITHDRAWALS WIT
 ON CAST(MOV.ID_PAGAMENTO AS STRING) = CAST(WIT.WIT_WITHDRAWAL_ID AS STRING)
AND WIT.SIT_SITE_ID = 'MLB');

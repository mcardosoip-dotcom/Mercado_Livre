import os
import random
from collections import Counter
import pandas as pd
import matplotlib.pyplot as plt
from openpyxl import load_workbook
from openpyxl.styles import PatternFill, Font, Alignment

# ===== Configuração de Diretório de Saída =====
output_dir     = r'C:\Users\mufranca\Desktop\Cartas'
os.makedirs(output_dir, exist_ok=True)
initial_path   = os.path.join(output_dir, 'cartas1.xlsx')
formatted_path = os.path.join(output_dir, 'cartas1_formatado.xlsx')

# ===== Parâmetros de Simulação =====
min_cards       = 1  # menor número de cartas
max_cards       = 30  # maior número de cartas
hands_per_n     = 500  # repetições por número de cartas
multiplicadores = {
    "Royal Flush":      10,
    "Straight Flush":    9,
    "Four of a Kind":    8,
    "Full House":        7,
    "Flush":             6,
    "Straight":          5,
    "Three of a Kind":   4,
    "Two Pair":          3,
    "One Pair":          2,
    "High Card":         1
}

# ===== Helpers de Poker =====
def numero_carta(c):
    m = {'A':14,'K':13,'Q':12,'J':11}
    v = c[:-1]
    return int(v) if v.isdigit() else m[v]

def valor_carta(c):
    v = c[:-1]
    if v in ('J','Q','K'): return 10
    if v == 'A': return 11
    return int(v)

def get_best_sequence(vals):
    u = sorted(set(vals))
    if set([14,2,3,4,5]).issubset(u):
        return [14,2,3,4,5]
    for i in range(len(u)-4):
        w = u[i:i+5]
        if w == list(range(w[0], w[0]+5)):
            return w
    return []

# ===== Classificação de Mão =====
def identificar_mao(mao):
    naipes     = [c[-1] for c in mao]
    cnt        = Counter(c[:-1] for c in mao)
    freq       = sorted(cnt.values(), reverse=True)
    nums       = [numero_carta(c) for c in mao]
    suit_cnt   = Counter(naipes)
    flush_suit = next((s for s,c in suit_cnt.items() if c >= 5), None)

    # 1. Royal Flush
    if flush_suit:
        suited = [c for c in mao if c[-1]==flush_suit]
        s_nums = [numero_carta(c) for c in suited]
        if set([10,11,12,13,14]).issubset(s_nums):
            return "Royal Flush", [c for c in suited if numero_carta(c) in [10,11,12,13,14]]
    # 2. Straight Flush
    if flush_suit:
        suited = [c for c in mao if c[-1]==flush_suit]
        seq    = get_best_sequence([numero_carta(c) for c in suited])
        if seq:
            return "Straight Flush", [c for c in suited if numero_carta(c) in seq]
    # 3. Four of a Kind
    if 4 in freq:
        return "Four of a Kind", [c for c in mao if cnt[c[:-1]]==4]
    # 4. Full House
    if 3 in freq and 2 in freq:
        trio = next(v for v,c in cnt.items() if c==3)
        pair = next(v for v,c in cnt.items() if c==2)
        return "Full House", [c for c in mao if c[:-1] in (trio,pair)]
    # 5. Flush
    if flush_suit:
        fcards = sorted([c for c in mao if c[-1]==flush_suit], key=numero_carta)[-5:]
        return "Flush", fcards
    # 6. Straight
    seq = get_best_sequence(nums)
    if seq:
        return "Straight", [c for c in mao if numero_carta(c) in seq]
    # 7. Three of a Kind
    if 3 in freq:
        v3 = next(v for v,c in cnt.items() if c==3)
        return "Three of a Kind", [c for c in mao if c[:-1]==v3]
    # 8. Two Pair
    if freq.count(2)>=2:
        pv = [v for v,c in cnt.items() if c==2][:2]
        return "Two Pair", [c for c in mao if c[:-1] in pv]
    # 9. One Pair
    if 2 in freq:
        vp = next(v for v,c in cnt.items() if c==2)
        return "One Pair", [c for c in mao if c[:-1]==vp]
    # 10. High Card
    hc = max(mao, key=numero_carta)
    return "High Card", [hc]

# ===== Simulação =====
results = []
deck = [f"{v}{s}" for v in (['A']+[str(i) for i in range(2,11)]+['J','Q','K']) 
        for s in ['♠','♥','♦','♣']]
for n in range(min_cards, max_cards+1):
    for _ in range(hands_per_n):
        mao = random.sample(deck, n)
        tipo, validas = identificar_mao(mao)
        pontos = sum(valor_carta(c) for c in validas) * multiplicadores[tipo]
        # categoria para plot
        if tipo=='High Card': cat_plot='High Card'
        elif tipo=='One Pair': cat_plot='Par'
        elif tipo=='Straight Flush': cat_plot='SF'
        elif tipo=='Royal Flush': cat_plot='RF'
        else: cat_plot='Outros'
        row = {'Quantidade':n, 'TipoCompleto':tipo, 'CategoriaPlot':cat_plot, 'Pontuação':pontos}
        for i in range(max_cards): row[f'Carta {i+1}'] = mao[i] if i<n else ''
        results.append(row)

# ===== Salvar e Formatar Excel =====
df = pd.DataFrame(results)
df.to_excel(initial_path, index=False)
wb = load_workbook(initial_path)
ws = wb.active
fill_red   = PatternFill('solid', fgColor='8B0000')
fill_black = PatternFill('solid', fgColor='000000')
white      = Font(color='FFFFFF')
center     = Alignment('center','center')
cols_carta = [c.column for c in ws[1] if str(c.value).startswith('Carta')]
for row in ws.iter_rows(min_row=2):
    for col in cols_carta:
        cell = row[col-1]
        if not cell.value:
            cell.fill = PatternFill(); cell.font = Font()
        else:
            cell.fill = fill_red if cell.value[-1] in ('♥','♦') else fill_black
            cell.font = white; cell.alignment = center
    row[0].alignment = center; row[1].alignment = center
wb.save(formatted_path)

# ===== Plot principais =====
df_plot    = df[['Quantidade','CategoriaPlot','Pontuação']]
counts     = df_plot.groupby(['Quantidade','CategoriaPlot']).size().unstack(fill_value=0)
avg_score  = df_plot.groupby('Quantidade')['Pontuação'].mean()
counts     = counts.reindex(columns=['High Card','Par','SF','RF','Outros'], fill_value=0)

fig, ax = plt.subplots()
counts.plot(kind='bar', stacked=True, ax=ax, zorder=1)
ax.set_xlabel('Quantidade de Cartas'); ax.set_ylabel('Contagem de Mãos')
# linha preta na frente
ax2 = ax.twinx()
ax2.plot(range(len(avg_score)), avg_score.values, color='black', marker='o', zorder=2)
ax2.set_ylim(0, avg_score.max()*1.1); ax2.set_ylabel('Média de Pontuação')
ax.set_xticks(range(len(avg_score))); ax.set_xticklabels(avg_score.index)
plt.title('Distribuição de Mãos e Média de Pontuação'); plt.tight_layout()
plt.savefig(os.path.join(output_dir,'plot_cartas.png'))
print('Gráfico salvo em plot_cartas.png')
plt.show()
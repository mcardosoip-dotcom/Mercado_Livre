<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Legal Analytics - Search</title>
  <style>
    :root {
      --primary: #1a73e8;
      --primary-hover: #1557b0;
      --primary-light: #e8f0fe;
      --surface: #f8f9fa;
      --border: #dadce0;
      --error-bg: #fce8e6;
      --error-text: #c5221f;
      --success-bg: #e6f4ea;
      --success-text: #137333;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --radius: 8px;
      --transition: 0.25s ease;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding: 16px 20px;
      margin: 0;
      font-size: 14px;
      background: linear-gradient(160deg, #f0f4ff 0%, #fafafa 100%);
      min-height: 100%;
      box-sizing: border-box;
    }

    .section {
      margin-bottom: 18px;
      animation: fadeInUp 0.4s ease backwards;
    }
    .section:nth-child(1) { animation-delay: 0.05s; }
    .section:nth-child(2) { animation-delay: 0.12s; }
    .section:nth-child(3) { animation-delay: 0.18s; }

    label.section-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--primary);
      letter-spacing: 0.02em;
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      box-sizing: border-box;
      background: #fff;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    select:hover {
      border-color: #bdc1c6;
    }
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .checkboxes {
      max-height: 220px;
      overflow-y: auto;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: #fff;
      box-shadow: var(--shadow-sm) inset;
      transition: box-shadow var(--transition), border-color var(--transition);
    }
    .checkboxes:hover {
      border-color: #bdc1c6;
    }
    .checkboxes.loaded label[data-col] {
      animation: fadeInUp 0.35s ease backwards;
    }
    .checkboxes.loaded label[data-col]:nth-child(1) { animation-delay: 0.05s; }
    .checkboxes.loaded label[data-col]:nth-child(2) { animation-delay: 0.08s; }
    .checkboxes.loaded label[data-col]:nth-child(3) { animation-delay: 0.11s; }
    .checkboxes.loaded label[data-col]:nth-child(4) { animation-delay: 0.14s; }
    .checkboxes.loaded label[data-col]:nth-child(5) { animation-delay: 0.17s; }
    .checkboxes.loaded label[data-col]:nth-child(n+6) { animation-delay: 0.2s; }
    .checkboxes label {
      font-weight: normal;
      margin: 6px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 6px;
      transition: background var(--transition), transform var(--transition);
    }
    .checkboxes label:hover {
      background: var(--primary-light);
    }
    .checkboxes input[type="checkbox"] {
      margin: 0;
      cursor: pointer;
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    .search-colunas {
      width: 100%;
      padding: 8px 12px 8px 32px;
      margin-bottom: 10px;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      box-sizing: border-box;
      background: #fff url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%239aa0a6" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 10px center;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .search-colunas::placeholder {
      color: #9aa0a6;
    }
    .search-colunas:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      animation: fadeInUp 0.4s ease 0.25s backwards;
    }
    button {
      padding: 10px 22px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
    }
    button:active {
      transform: scale(0.97);
    }
    .btn-ok {
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    .btn-ok:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .btn-ok:disabled {
      background: #bdc1c6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-ok.processing {
      animation: pulse 1s ease infinite;
    }
    .btn-cancel {
      background: #fff;
      color: #5f6368;
      border: 2px solid var(--border);
    }
    .btn-cancel:hover {
      background: #f1f3f4;
      border-color: #bdc1c6;
    }

    .msg {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: var(--radius);
      display: none;
      animation: fadeInUp 0.35s ease;
    }
    .msg.error {
      background: var(--error-bg);
      color: var(--error-text);
      border: 1px solid #f5c6cb;
      animation: shake 0.4s ease;
    }
    .msg.success {
      background: var(--success-bg);
      color: var(--success-text);
      border: 1px solid #a3d9a5;
    }

    .loading {
      text-align: center;
      padding: 24px;
      color: #5f6368;
      animation: fadeIn 0.3s ease;
    }
    .loading::after {
      content: '';
      display: inline-block;
      width: 22px;
      height: 22px;
      margin-left: 10px;
      vertical-align: middle;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .view-form.hidden {
      display: none !important;
    }
    .view-result {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .view-result.visible {
      display: block;
    }
    .view-result .result-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }
    .view-result .result-title {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: var(--primary);
      font-weight: 700;
    }
    .view-result .result-count {
      font-size: 13px;
      color: #5f6368;
    }
    .view-result .preview-block {
      margin-bottom: 20px;
    }
    .view-result .preview-block h3 {
      margin: 0 0 10px 0;
      font-size: 13px;
      color: #5f6368;
      font-weight: 600;
    }
    .view-result .preview-table-wrap {
      max-height: 280px;
      overflow: auto;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: #fff;
      margin-bottom: 20px;
    }
    .view-result .preview-table-wrap table {
      width: 100%;
      min-width: 400px;
      border-collapse: collapse;
      font-size: 12px;
    }
    .view-result .preview-table-wrap th,
    .view-result .preview-table-wrap td {
      padding: 10px 14px;
      text-align: left;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }
    .view-result .preview-table-wrap th {
      background: var(--primary-light);
      font-weight: 600;
      color: var(--primary);
      position: sticky;
      top: 0;
    }
    .view-result .preview-table-wrap tr:hover td {
      background: #f8f9fa;
    }
    .view-result .result-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .btn-download {
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: linear-gradient(180deg, #0d9e34 0%, #0a7d29 100%);
      color: white;
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .btn-download:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    .btn-nova-consulta {
      padding: 10px 16px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: 2px solid var(--border);
      background: #fff;
      color: #5f6368;
      transition: background var(--transition), border-color var(--transition);
    }
    .btn-nova-consulta:hover {
      background: #f1f3f4;
      border-color: #bdc1c6;
    }
    .dialog-page-title {
      margin: 0 0 18px 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="view-form" id="viewForm">
    <h1 class="dialog-page-title">Legal Analytics - Search</h1>
    <div class="section">
      <label for="campoFiltro" class="section-label">Campo associado à consulta</label>
      <select id="campoFiltro">
        <option value="">Selecione o campo...</option>
      </select>
    </div>
    <div class="section">
      <label class="section-label">Informações que deseja trazer</label>
      <input type="text" class="search-colunas" id="searchColunas" placeholder="Pesquisar colunas..." autocomplete="off">
      <div class="checkboxes" id="containerCheckboxes">
        <div class="loading" id="loadingCols">Carregando colunas...</div>
      </div>
    </div>
    <div class="msg" id="msg"></div>
    <div class="actions">
      <button type="button" class="btn-cancel" id="btnCancel">Cancelar</button>
      <button type="button" class="btn-ok" id="btnOk">OK</button>
    </div>
  </div>

  <div class="view-result" id="viewResult">
    <div class="result-header">
      <h2 class="result-title">Resultado da consulta</h2>
      <p class="result-count" id="resultCount"></p>
    </div>
    <div class="preview-block">
      <h3>Preview (10 primeiras linhas)</h3>
      <div class="preview-table-wrap">
        <table>
          <thead id="previewThead"></thead>
          <tbody id="previewTbody"></tbody>
        </table>
      </div>
    </div>
    <div class="result-actions">
      <button type="button" class="btn-download" id="btnDownloadCsv">Baixar CSV (escolher onde salvar)</button>
      <button type="button" class="btn-nova-consulta" id="btnNovaConsulta">Nova consulta</button>
    </div>
  </div>

  <script>
    (function() {
      var campoFiltro = document.getElementById('campoFiltro');
      var searchColunas = document.getElementById('searchColunas');
      var containerCheckboxes = document.getElementById('containerCheckboxes');
      var loadingCols = document.getElementById('loadingCols');
      var msg = document.getElementById('msg');
      var btnOk = document.getElementById('btnOk');
      var btnCancel = document.getElementById('btnCancel');
      var viewForm = document.getElementById('viewForm');
      var viewResult = document.getElementById('viewResult');
      var resultCount = document.getElementById('resultCount');
      var previewThead = document.getElementById('previewThead');
      var previewTbody = document.getElementById('previewTbody');
      var btnDownloadCsv = document.getElementById('btnDownloadCsv');
      var btnNovaConsulta = document.getElementById('btnNovaConsulta');
      var lastCsvContent = null;

      function showMessage(text, type) {
        msg.textContent = text;
        msg.className = 'msg ' + (type || '');
        msg.style.display = 'block';
      }

      function hideMessage() {
        msg.style.display = 'none';
      }

      function fillDialog() {
        google.script.run
          .withSuccessHandler(function(columnNames) {
            loadingCols.style.display = 'none';
            if (!columnNames || columnNames.length === 0) {
              containerCheckboxes.innerHTML = '<p>Nenhuma coluna encontrada.</p>';
              return;
            }
            columnNames.forEach(function(name) {
              var opt = document.createElement('option');
              opt.value = name;
              opt.textContent = name;
              campoFiltro.appendChild(opt);
            });
            var frag = document.createDocumentFragment();
            columnNames.forEach(function(name) {
              var label = document.createElement('label');
              label.setAttribute('data-col', name);
              var cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.value = name;
              cb.name = 'col';
              label.appendChild(cb);
              label.appendChild(document.createTextNode(name));
              frag.appendChild(label);
            });
            containerCheckboxes.appendChild(frag);
            containerCheckboxes.classList.add('loaded');

            function aplicaFiltro() {
              var filtroCampo = campoFiltro.value;
              var busca = (searchColunas.value || '').trim().toLowerCase();
              containerCheckboxes.querySelectorAll('label[data-col]').forEach(function(label) {
                var col = label.getAttribute('data-col');
                var escondidoPorCampo = (col === filtroCampo);
                var passaBusca = !busca || col.toLowerCase().indexOf(busca) !== -1;
                if (escondidoPorCampo) {
                  label.style.display = 'none';
                  label.querySelector('input').checked = false;
                } else {
                  label.style.display = passaBusca ? '' : 'none';
                }
              });
            }

            campoFiltro.addEventListener('change', aplicaFiltro);
            searchColunas.addEventListener('input', aplicaFiltro);
          })
          .withFailureHandler(function(err) {
            loadingCols.style.display = 'none';
            containerCheckboxes.innerHTML = '<p style="color:#c5221f;">Erro ao carregar colunas: ' + (err.message || err) + '</p>';
          })
          .getColumnNames();
      }

      function getSelectedColumns() {
        var nodes = containerCheckboxes.querySelectorAll('input[name="col"]:checked');
        var arr = [];
        for (var i = 0; i < nodes.length; i++) {
          arr.push(nodes[i].value);
        }
        return arr;
      }

      function doOk() {
        var field = campoFiltro.value;
        var cols = getSelectedColumns();
        if (!field) {
          showMessage('Selecione o campo associado à consulta.', 'error');
          return;
        }
        if (cols.length === 0) {
          showMessage('Marque pelo menos uma coluna para retornar (o campo de pesquisa já virá automaticamente).', 'error');
          return;
        }
        hideMessage();
        btnOk.disabled = true;
        btnOk.textContent = 'Processando...';
        btnOk.classList.add('processing');
        google.script.run
          .withSuccessHandler(function(result) {
            btnOk.disabled = false;
            btnOk.textContent = 'OK';
            btnOk.classList.remove('processing');
            if (result.success) {
              lastCsvContent = result.csvContent || null;
              if (result.headers && result.previewRows) {
                resultCount.textContent = result.rowCount + ' linha(s) no total. Baixe o CSV para ver todos os dados.';
                previewThead.innerHTML = '';
                var trHead = document.createElement('tr');
                result.headers.forEach(function(h) {
                  var th = document.createElement('th');
                  th.textContent = h;
                  trHead.appendChild(th);
                });
                previewThead.appendChild(trHead);
                previewTbody.innerHTML = '';
                result.previewRows.forEach(function(row) {
                  var tr = document.createElement('tr');
                  row.forEach(function(cell) {
                    var td = document.createElement('td');
                    td.textContent = cell !== null && cell !== undefined ? cell : '';
                    tr.appendChild(td);
                  });
                  previewTbody.appendChild(tr);
                });
                viewForm.classList.add('hidden');
                viewResult.classList.add('visible');
              }
            } else {
              showMessage(result.message || 'Erro ao executar consulta.', 'error');
            }
          })
          .withFailureHandler(function(err) {
            btnOk.disabled = false;
            btnOk.textContent = 'OK';
            btnOk.classList.remove('processing');
            showMessage('Erro: ' + (err.message || err), 'error');
          })
          .executarConsulta(field, cols);
      }

      btnOk.addEventListener('click', doOk);
      btnCancel.addEventListener('click', function() {
        google.script.host.close();
      });

      btnDownloadCsv.addEventListener('click', function() {
        if (!lastCsvContent) return;
        var blob = new Blob([lastCsvContent], { type: 'text/csv;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        var now = new Date();
        var name = 'consulta_resultado_' + now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + '_' + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0') + '.csv';
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      btnNovaConsulta.addEventListener('click', function() {
        viewResult.classList.remove('visible');
        viewForm.classList.remove('hidden');
        hideMessage();
      });

      fillDialog();
    })();
  </script>
</body>
</html>
